<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نقطه و خط حرفه‌ای</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "three": "https://esm.sh/three",
        "nipplejs": "https://esm.sh/nipplejs"
      }
    }
    </script>
    <style>
        body {
            user-select: none;
            touch-action: none;
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
        }

        #bg-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.6;
            background: 
                radial-gradient(at 0% 0%, #1e1b4b 0, transparent 50%), 
                radial-gradient(at 50% 50%, #0f172a 0, transparent 80%), 
                radial-gradient(at 100% 0%, #312e81 0, transparent 50%),
                radial-gradient(at 50% 100%, #1e1b4b 0, transparent 50%);
            filter: blur(60px);
            animation: mesh-flow 15s infinite alternate ease-in-out;
        }

        @keyframes mesh-flow {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.1) rotate(2deg); }
        }

        #game-canvas {
            max-width: 95vw;
            max-height: 70vh;
            cursor: crosshair;
            filter: drop-shadow(0 0 30px rgba(0,0,0,0.8));
            border-radius: 2rem;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 1rem center;
            background-size: 1.5em;
        }

        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.75rem; }
        
        .menu-btn {
            @apply transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-[0_0_20px_rgba(0,0,0,0.3)] hover:shadow-blue-500/20;
        }

        /* Ads Footer & Webview */
        
    </style>
</head>
<body class="bg-slate-950 text-white overflow-hidden h-screen flex flex-col">
    <div id="bg-mesh"></div>

    <!-- Main Menu -->
    <div id="main-menu" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-950/40 backdrop-blur-sm p-6">
        <h1 class="text-6xl font-black mb-12 tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-blue-300 via-blue-500 to-purple-600 drop-shadow-2xl text-center">
            نقطه و خط
        </h1>
        
        <div class="flex flex-col gap-5 w-full max-w-xs">
            <button id="btn-pvp" class="menu-btn bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-5 px-8 rounded-3xl shadow-xl">
                بازی دو نفره
            </button>
            <button id="btn-pve" class="menu-btn bg-gradient-to-r from-purple-600 to-purple-700 text-white font-bold py-5 px-8 rounded-3xl shadow-xl">
                بازی با ربات
            </button>
            <button id="btn-settings" class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-white font-bold py-5 px-8 rounded-3xl shadow-xl">
                تنظیمات
            </button>
        </div>
        
        <p class="mt-16 text-slate-400 text-sm font-medium opacity-80">کاری از سید آروین موسوی</p>
    </div>

    <!-- Settings Menu -->
    <div id="settings-menu" class="hidden absolute inset-0 z-[60] flex flex-col items-center justify-center bg-slate-950/95 backdrop-blur-xl p-6">
        <h2 class="text-3xl font-bold mb-10 text-blue-400">تنظیمات بازی</h2>
        
        <div class="w-full max-w-sm space-y-8">
            <div class="space-y-3">
                <label class="text-sm font-bold text-slate-400 block pr-1">اندازه صفحه</label>
                <select id="setting-grid" class="w-full bg-slate-800/50 p-4 rounded-2xl outline-none border border-slate-700 focus:border-blue-500 transition-colors">
                    <option value="3">کوچک (۳×۳)</option>
                    <option value="5" selected>متوسط (۵×۵)</option>
                    <option value="8">بزرگ (۸×۸)</option>
                    <option value="12">خیلی بزرگ (۱۲×۱۲)</option>
                </select>
            </div>

            <div class="space-y-3">
                <label class="text-sm font-bold text-slate-400 block pr-1">سختی ربات</label>
                <select id="setting-difficulty" class="w-full bg-slate-800/50 p-4 rounded-2xl outline-none border border-slate-700 focus:border-blue-500 transition-colors">
                    <option value="easy">آسان (تصادفی)</option>
                    <option value="medium" selected>متوسط (هوشمند)</option>
                    <option value="hard">سخت (حرفه‌ای)</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-400 block pr-1 text-center">رنگ بازیکن ۱</label>
                    <input type="color" id="setting-p1-color" value="#3b82f6" class="w-full h-14 bg-transparent cursor-pointer rounded-2xl">
                </div>
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-400 block pr-1 text-center">رنگ بازیکن ۲</label>
                    <input type="color" id="setting-p2-color" value="#ef4444" class="w-full h-14 bg-transparent cursor-pointer rounded-2xl">
                </div>
            </div>

            <div class="pt-2">
                <label class="flex items-center space-x-4 space-x-reverse cursor-pointer group">
                    <input type="checkbox" id="setting-bloom" checked class="w-6 h-6 rounded-lg border-slate-700 bg-slate-800 text-blue-500 focus:ring-blue-500">
                    <span class="text-base font-bold text-slate-300 group-hover:text-white transition-colors">جلوه‌های گرافیکی ویژه (Bloom)</span>
                </label>
            </div>
        </div>
        
        <button id="btn-settings-back" class="mt-12 bg-blue-500 hover:bg-blue-400 text-white font-bold py-4 px-16 rounded-full shadow-[0_10px_30px_rgba(59,130,246,0.4)] transition-all active:scale-95">
            تایید و بازگشت
        </button>
    </div>

    <!-- Game UI Overlay -->
    <div id="game-ui" class="flex flex-col h-full pointer-events-none p-4 max-w-2xl mx-auto w-full">
        <!-- Stats -->
        <div class="flex justify-between items-stretch mb-4 gap-2">
            <div id="p1-score-card" class="flex-1 glass-panel border-r-4 border-blue-500 p-4 rounded-2xl transition-all flex flex-col items-center">
                <div class="text-[10px] uppercase tracking-widest font-black opacity-50 mb-1">بازیکن ۱</div>
                <div id="p1-score" class="text-4xl font-black text-blue-400">۰</div>
            </div>
            
            <div class="flex flex-col items-center justify-center gap-2 px-2">
                <div id="turn-indicator" class="text-xs font-black bg-white/5 backdrop-blur-xl px-4 py-2 rounded-full border border-white/10 shadow-2xl text-white whitespace-nowrap">نوبت بازیکن ۱</div>
                <div class="w-1 h-12 bg-gradient-to-b from-transparent via-white/20 to-transparent"></div>
            </div>

            <div id="p2-score-card" class="flex-1 glass-panel border-l-4 border-red-500 p-4 rounded-2xl transition-all flex flex-col items-center">
                <div class="text-[10px] uppercase tracking-widest font-black opacity-50 mb-1" id="p2-label">بازیکن ۲</div>
                <div id="p2-score" class="text-4xl font-black text-red-400">۰</div>
            </div>
        </div>

        <!-- Canvas Container -->
        <div class="flex-grow flex items-center justify-center pointer-events-auto overflow-hidden relative" id="canvas-wrapper">
            <canvas id="game-canvas"></canvas>
        </div>

        <!-- Footer -->
        <div class="mt-6 flex flex-col items-center gap-4 pointer-events-auto">
            <div class="flex justify-between w-full px-4">
                <button id="btn-game-exit" class="text-slate-400 hover:text-red-400 transition-colors text-sm font-bold py-2 px-4 rounded-xl hover:bg-white/5">
                    خروج از بازی
                </button>
                <button id="btn-game-reset" class="text-slate-400 hover:text-blue-400 transition-colors text-sm font-bold py-2 px-4 rounded-xl hover:bg-white/5">
                    شروع مجدد
                </button>
            </div>
            <p class="text-[10px] text-slate-500 opacity-60 font-medium">کاری از سید آروین موسوی</p>
        </div>
    </div>

    <!-- Ads Webview Overlay -->
    <div id="ads-webview-container">
        <div class="flex items-center justify-between p-4 bg-slate-900 border-b border-slate-800">
            <button id="btn-ads-close" class="flex items-center gap-2 text-slate-300 hover:text-white transition-colors">
                <svg class="w-6 h-6 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                <span class="font-bold">بازگشت</span>
            </button>
            <h3 class="text-lg font-black text-white">فرم ثبت تبلیغ</h3>
            <div class="w-10"></div> <!-- Spacer -->
        </div>
        <div class="flex-grow relative bg-white">
            <iframe id="ads-iframe" class="absolute inset-0 w-full h-full border-none" src=""></iframe>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over" class="hidden absolute inset-0 z-[70] flex flex-col items-center justify-center bg-slate-950/95 backdrop-blur-2xl p-10 text-center">
        <div class="w-28 h-28 mb-8 rounded-full bg-slate-800/50 flex items-center justify-center border border-slate-700 shadow-2xl">
            <svg class="w-14 h-14 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
        </div>
        <h2 id="winner-text" class="text-5xl font-black mb-4 tracking-tight drop-shadow-lg">بازیکن ۱ برنده شد!</h2>
        <p id="final-score" class="text-slate-400 text-lg mb-14">نتیجه نهایی: ۱۲ - ۸</p>
        
        <button id="btn-play-again" class="bg-gradient-to-r from-blue-600 to-blue-500 text-white font-black py-5 px-16 rounded-3xl shadow-2xl transition-all active:scale-95 text-xl">
            بازی دوباره
        </button>
        <p class="mt-12 text-slate-500 text-xs">کاری از سید آروین موسوی</p>
    </div>

    <script type="module">
        /**
         * Pro Dots & Boxes - Main Game Logic
         */

        class SoundManager {
            constructor() {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
                this.buffers = {};
            }

            async load(name, url) {
                try {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    this.buffers[name] = await this.context.decodeAudioData(arrayBuffer);
                } catch (e) {
                    console.warn(`Failed to load sound: ${name}`);
                }
            }

            play(name) {
                if (!this.buffers[name]) return;
                if (this.context.state === 'suspended') {
                    this.context.resume();
                }
                const source = this.context.createBufferSource();
                source.buffer = this.buffers[name];
                source.connect(this.context.destination);
                source.start(0);
            }
        }

        const sounds = new SoundManager();
        sounds.load('line', 'line_draw.mp3');
        sounds.load('box', 'box_complete.mp3');
        sounds.load('win', 'victory.mp3');

        // --- Game State ---
        const state = {
            gridSize: 5,
            difficulty: 'medium',
            p1Color: '#3b82f6',
            p2Color: '#ef4444',
            isPvE: true,
            currentPlayer: 1, // 1 or 2
            dots: [],
            lines: [], // {p1, p2, owner, lastMoved: timestamp}
            boxes: [], // {indices: [4 dots], owner}
            scores: { 1: 0, 2: 0 },
            isGameOver: false,
            bloom: true,
            canvas: null,
            ctx: null,
            hoveredLine: null,
            lastMoveTime: 0,
            lastLine: null
        };

        // --- Initialization ---
        function init() {
            state.canvas = document.getElementById('game-canvas');
            state.ctx = state.canvas.getContext('2d');
            
            setupEventListeners();
            resetGame();
            animate();
        }

        function setupEventListeners() {
            window.addEventListener('resize', resizeCanvas);
            
            // History API for Mobile Back Button
            window.onpopstate = (e) => {
                const view = e.state?.view || 'menu';
                closeAllScreens();
                if (view === 'settings') {
                    document.getElementById('settings-menu').classList.remove('hidden');
                } else if (view === 'ads') {
                    openAdsView();
                } else if (view === 'game') {
                    // Stay in game
                } else {
                    document.getElementById('main-menu').classList.remove('hidden');
                }
            };

            function closeAllScreens() {
                document.getElementById('main-menu').classList.add('hidden');
                document.getElementById('settings-menu').classList.add('hidden');
                document.getElementById('game-over').classList.add('hidden');
                document.getElementById('ads-webview-container').classList.remove('active');
            }

            const canvas = state.canvas;
            
            const handleMove = (e) => {
                if (state.isGameOver || (state.isPvE && state.currentPlayer === 2)) return;
                const rect = canvas.getBoundingClientRect();
                const clientX = e.clientX !== undefined ? e.clientX : (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
                const clientY = e.clientY !== undefined ? e.clientY : (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
                
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                updateHoveredLine(x, y);
            };

            const handleClick = (e) => {
                if (state.isGameOver || (state.isPvE && state.currentPlayer === 2)) return;
                if (state.hoveredLine) {
                    makeMove(state.hoveredLine);
                }
            };

            canvas.addEventListener('mousemove', handleMove);
            canvas.addEventListener('mousedown', handleClick);
            canvas.addEventListener('touchstart', (e) => {
                handleMove(e);
                handleClick(e);
            }, { passive: false });

            // Menu Buttons
            document.getElementById('btn-pvp').onclick = () => {
                state.isPvE = false;
                document.getElementById('p2-label').textContent = 'بازیکن ۲';
                history.pushState({ view: 'game' }, '');
                startGame();
            };
            
            document.getElementById('btn-pve').onclick = () => {
                state.isPvE = true;
                document.getElementById('p2-label').textContent = 'ربات';
                history.pushState({ view: 'game' }, '');
                startGame();
            };

            document.getElementById('btn-settings').onclick = () => {
                history.pushState({ view: 'settings' }, '');
                document.getElementById('settings-menu').classList.remove('hidden');
            };

            document.getElementById('btn-settings-back').onclick = () => {
                applySettings();
                window.history.back();
            };

            document.getElementById('btn-game-exit').onclick = () => {
                window.history.back();
            };

            document.getElementById('btn-game-reset').onclick = resetGame;
            document.getElementById('btn-play-again').onclick = resetGame;

            // Ads Logic
            document.getElementById('btn-ads-open').onclick = (e) => {
                e.preventDefault();
                history.pushState({ view: 'ads' }, '');
                openAdsView();
            };

            document.getElementById('btn-ads-close').onclick = () => {
                window.history.back();
            };
        }

        function openAdsView() {
            const container = document.getElementById('ads-webview-container');
            const iframe = document.getElementById('ads-iframe');
            const url = 'https://forms.gle/UHJ8mChHrEN4WFBa9';
            
            if (iframe.src !== url) {
                iframe.src = url;
            }
            container.classList.add('active');
        }

        function applySettings() {
            state.gridSize = parseInt(document.getElementById('setting-grid').value);
            state.difficulty = document.getElementById('setting-difficulty').value;
            state.p1Color = document.getElementById('setting-p1-color').value;
            state.p2Color = document.getElementById('setting-p2-color').value;
            state.bloom = document.getElementById('setting-bloom').checked;
            resetGame();
        }

        function startGame() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            resetGame();
        }

        function resetGame() {
            state.currentPlayer = 1;
            state.scores = { 1: 0, 2: 0 };
            state.isGameOver = false;
            state.lines = [];
            state.boxes = [];
            state.hoveredLine = null;
            
            document.getElementById('game-over').classList.add('hidden');
            updateUI();
            resizeCanvas();
            
            // Generate Dots
            state.dots = [];
            for (let r = 0; r <= state.gridSize; r++) {
                for (let c = 0; c <= state.gridSize; c++) {
                    state.dots.push({ r, c });
                }
            }

            // Generate potential lines
            state.lines = [];
            for (let r = 0; r <= state.gridSize; r++) {
                for (let c = 0; c <= state.gridSize; c++) {
                    // Horizontal
                    if (c < state.gridSize) {
                        state.lines.push({
                            p1: r * (state.gridSize + 1) + c,
                            p2: r * (state.gridSize + 1) + (c + 1),
                            owner: 0,
                            type: 'h'
                        });
                    }
                    // Vertical
                    if (r < state.gridSize) {
                        state.lines.push({
                            p1: r * (state.gridSize + 1) + c,
                            p2: (r + 1) * (state.gridSize + 1) + c,
                            owner: 0,
                            type: 'v'
                        });
                    }
                }
            }

            // Generate Boxes
            state.boxes = [];
            for (let r = 0; r < state.gridSize; r++) {
                for (let c = 0; c < state.gridSize; c++) {
                    const tl = r * (state.gridSize + 1) + c;
                    const tr = tl + 1;
                    const bl = (r + 1) * (state.gridSize + 1) + c;
                    const br = bl + 1;
                    
                    // Find the 4 lines that make this box
                    const boxLines = [
                        state.lines.find(l => l.p1 === tl && l.p2 === tr), // Top
                        state.lines.find(l => l.p1 === bl && l.p2 === br), // Bottom
                        state.lines.find(l => l.p1 === tl && l.p2 === bl), // Left
                        state.lines.find(l => l.p1 === tr && l.p2 === br)  // Right
                    ];
                    
                    state.boxes.push({
                        r, c,
                        lines: boxLines,
                        owner: 0
                    });
                }
            }
        }

        function resizeCanvas() {
            const wrapper = document.getElementById('canvas-wrapper');
            if (!wrapper) return;
            const size = Math.min(wrapper.clientWidth, wrapper.clientHeight) - 40;
            state.canvas.width = size;
            state.canvas.height = size;
        }

        function updateHoveredLine(x, y) {
            const margin = state.canvas.width * 0.1;
            const innerSize = state.canvas.width - margin * 2;
            const step = innerSize / state.gridSize;
            
            let bestDist = 20;
            let bestLine = null;

            state.lines.forEach(line => {
                if (line.owner !== 0) return;
                
                const d1 = state.dots[line.p1];
                const d2 = state.dots[line.p2];
                
                const x1 = margin + d1.c * step;
                const y1 = margin + d1.r * step;
                const x2 = margin + d2.c * step;
                const y2 = margin + d2.r * step;
                
                // Midpoint dist
                const mx = (x1 + x2) / 2;
                const my = (y1 + y2) / 2;
                const dist = Math.sqrt((x - mx)**2 + (y - my)**2);
                
                if (dist < bestDist) {
                    bestDist = dist;
                    bestLine = line;
                }
            });

            state.hoveredLine = bestLine;
        }

        function makeMove(line) {
            if (line.owner !== 0) return;
            
            line.owner = state.currentPlayer;
            state.lastLine = line;
            state.lastMoveTime = Date.now();
            sounds.play('line');
            
            const boxesCompleted = checkBoxes();
            
            if (boxesCompleted > 0) {
                sounds.play('box');
                if (isBoardFull()) {
                    endGame();
                } else if (state.isPvE && state.currentPlayer === 2) {
                    setTimeout(robotMove, 400);
                }
            } else {
                state.currentPlayer = state.currentPlayer === 1 ? 2 : 1;
                updateUI();
                
                if (state.isPvE && state.currentPlayer === 2) {
                    setTimeout(robotMove, 500);
                }
            }
        }

        function checkBoxes() {
            let completed = 0;
            state.boxes.forEach(box => {
                if (box.owner === 0 && box.lines.every(l => l.owner !== 0)) {
                    box.owner = state.currentPlayer;
                    state.scores[state.currentPlayer]++;
                    completed++;
                }
            });
            updateUI();
            return completed;
        }

        function isBoardFull() {
            return state.lines.every(l => l.owner !== 0);
        }

        function toPersianDigits(n) {
            const farsiDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return n.toString().replace(/\d/g, x => farsiDigits[x]);
        }

        function updateUI() {
            document.getElementById('p1-score').textContent = toPersianDigits(state.scores[1]);
            document.getElementById('p2-score').textContent = toPersianDigits(state.scores[2]);
            
            const indicator = document.getElementById('turn-indicator');
            const p1Card = document.getElementById('p1-score-card');
            const p2Card = document.getElementById('p2-score-card');

            if (state.currentPlayer === 1) {
                indicator.textContent = "نوبت بازیکن ۱";
                indicator.style.color = state.p1Color;
                p1Card.style.opacity = "1";
                p2Card.style.opacity = "0.4";
                p1Card.style.transform = "scale(1.1)";
                p2Card.style.transform = "scale(1.0)";
            } else {
                indicator.textContent = "نوبت " + (state.isPvE ? "ربات" : "بازیکن ۲");
                indicator.style.color = state.p2Color;
                p1Card.style.opacity = "0.4";
                p2Card.style.opacity = "1";
                p1Card.style.transform = "scale(1.0)";
                p2Card.style.transform = "scale(1.1)";
            }
        }

        function endGame() {
            state.isGameOver = true;
            sounds.play('win');
            
            const winnerText = document.getElementById('winner-text');
            const finalScore = document.getElementById('final-score');
            
            if (state.scores[1] > state.scores[2]) {
                winnerText.textContent = "بازیکن ۱ برنده شد!";
                winnerText.style.color = state.p1Color;
            } else if (state.scores[2] > state.scores[1]) {
                winnerText.textContent = (state.isPvE ? "ربات برنده شد!" : "بازیکن ۲ برنده شد!");
                winnerText.style.color = state.p2Color;
            } else {
                winnerText.textContent = "بازی مساوی شد!";
                winnerText.style.color = "white";
            }
            
            finalScore.textContent = `امتیاز نهایی: ${toPersianDigits(state.scores[1])} - ${toPersianDigits(state.scores[2])}`;
            
            setTimeout(() => {
                document.getElementById('game-over').classList.remove('hidden');
            }, 1000);
        }

        // --- Robot AI ---
        function robotMove() {
            if (state.isGameOver || !state.isPvE) return;

            const availableLines = state.lines.filter(l => l.owner === 0);
            if (availableLines.length === 0) return;

            let selectedLine = null;

            // AI Levels
            if (state.difficulty === 'easy') {
                selectedLine = availableLines[Math.floor(Math.random() * availableLines.length)];
            } else {
                // 1. Can I finish a box?
                const finishableBox = state.boxes.find(b => b.owner === 0 && b.lines.filter(l => l.owner !== 0).length === 3);
                if (finishableBox) {
                    selectedLine = finishableBox.lines.find(l => l.owner === 0);
                } else if (state.difficulty === 'hard') {
                    // 2. Hard Mode: Avoid giving the opponent a box (lines that would complete 3rd side)
                    const safeLines = availableLines.filter(l => {
                        // Check every box this line belongs to
                        const parentBoxes = state.boxes.filter(b => b.lines.includes(l));
                        return parentBoxes.every(b => b.lines.filter(ln => ln.owner !== 0).length < 2);
                    });
                    
                    if (safeLines.length > 0) {
                        selectedLine = safeLines[Math.floor(Math.random() * safeLines.length)];
                    } else {
                        // If no safe lines, just take the one that gives away the fewest boxes (heuristic: random for now)
                        selectedLine = availableLines[Math.floor(Math.random() * availableLines.length)];
                    }
                } else {
                    // Normal Mode: Simple random move from available lines
                    selectedLine = availableLines[Math.floor(Math.random() * availableLines.length)];
                }
            }

            if (selectedLine) makeMove(selectedLine);
        }

        // --- Rendering ---
        function animate() {
            render();
            requestAnimationFrame(animate);
        }

        function render() {
            const ctx = state.ctx;
            const canvas = state.canvas;
            if (!ctx || !canvas) return;
            const margin = canvas.width * 0.1;
            const innerSize = canvas.width - margin * 2;
            const step = innerSize / state.gridSize;
            const time = Date.now() * 0.002;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Subtle Grid Background
            ctx.strokeStyle = 'rgba(255,255,255,0.03)';
            ctx.lineWidth = 1;
            for(let i=0; i<=state.gridSize; i++) {
                const pos = margin + i * step;
                ctx.beginPath(); ctx.moveTo(pos, margin); ctx.lineTo(pos, canvas.height - margin); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(margin, pos); ctx.lineTo(canvas.width - margin, pos); ctx.stroke();
            }

            // Draw Boxes (Fills)
            state.boxes.forEach(box => {
                if (box.owner !== 0) {
                    const x = margin + box.c * step;
                    const y = margin + box.r * step;
                    
                    const baseColor = box.owner === 1 ? state.p1Color : state.p2Color;
                    const gradient = ctx.createRadialGradient(x + step/2, y + step/2, 0, x + step/2, y + step/2, step);
                    gradient.addColorStop(0, baseColor + '44');
                    gradient.addColorStop(1, baseColor + '11');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.roundRect(x + 4, y + 4, step - 8, step - 8, 8);
                    ctx.fill();
                    
                    // Owner Label with subtle floating effect
                    const offsetY = Math.sin(time + (box.r * 0.5) + (box.c * 0.5)) * 2;
                    ctx.fillStyle = baseColor;
                    ctx.font = `bold ${step * 0.45}px 'Vazirmatn'`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const label = box.owner === 1 ? '۱' : (state.isPvE ? 'ر' : '۲');
                    
                    if (state.bloom) {
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = baseColor;
                    }
                    ctx.fillText(label, x + step/2, y + step/2 + offsetY);
                    ctx.shadowBlur = 0;
                }
            });

            // Draw Lines
            state.lines.forEach(line => {
                const d1 = state.dots[line.p1];
                const d2 = state.dots[line.p2];
                const x1 = margin + d1.c * step;
                const y1 = margin + d1.r * step;
                const x2 = margin + d2.c * step;
                const y2 = margin + d2.r * step;

                const isHovered = state.hoveredLine === line;
                const isLast = state.lastLine === line;
                
                if (line.owner !== 0 || isHovered) {
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    
                    if (line.owner !== 0) {
                        const baseColor = line.owner === 1 ? state.p1Color : state.p2Color;
                        ctx.strokeStyle = baseColor;
                        ctx.lineWidth = isLast ? 8 : 5;
                        
                        if (state.bloom) {
                            const pulse = isLast ? (Math.sin(Date.now() * 0.01) * 10 + 20) : 12;
                            ctx.shadowBlur = pulse;
                            ctx.shadowColor = baseColor;
                        }
                    } else {
                        const hoverColor = state.currentPlayer === 1 ? state.p1Color : state.p2Color;
                        ctx.strokeStyle = hoverColor + '88';
                        ctx.lineWidth = 4;
                        ctx.setLineDash([8, 4]);
                    }
                    
                    ctx.lineCap = 'round';
                    ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.shadowBlur = 0;
                }
            });

            // Draw Dots (Pegs)
            state.dots.forEach(dot => {
                const x = margin + dot.c * step;
                const y = margin + dot.r * step;
                
                // Outer ring
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fillStyle = '#0f172a';
                ctx.fill();
                
                // Inner core
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fillStyle = '#94a3b8';
                
                if (state.bloom) {
                    ctx.shadowBlur = 8;
                    ctx.shadowColor = 'rgba(255,255,255,0.5)';
                }
                ctx.fill();
                ctx.shadowBlur = 0;
            });
        }

        // Start
        init();
    </script>
</body>
</html>
