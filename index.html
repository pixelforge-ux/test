<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯ÙˆØ² Ù¾ÛŒØ´Ø±ÙØªÙ‡ | Ø³ÛŒØ¯ Ø¢Ø±ÙˆÛŒÙ† Ù…ÙˆØ³ÙˆÛŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            background: var(--bg-color, #0f172a);
        }
        canvas#bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            width: 100%;
            height: 100%;
        }
        .glass {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .theme-classic .glass { 
            background: rgba(255, 255, 255, 0.92); 
            border: 1px solid rgba(0, 0, 0, 0.1);
            text-shadow: none;
        }
        
        .cell {
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.05);
        }
        .theme-classic .cell { background: rgba(0, 0, 0, 0.05); }

        .active-choice {
            background: rgba(59, 130, 246, 0.2) !important;
            border-color: rgba(59, 130, 246, 0.8) !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        @keyframes footerColor {
            0% { color: #3b82f6; }
            25% { color: #8b5cf6; }
            50% { color: #ef4444; }
            75% { color: #10b981; }
            100% { color: #3b82f6; }
        }
        .footer-animated {
            animation: footerColor 8s infinite linear;
            text-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .cell:active { transform: scale(0.9); }
        .hidden { display: none !important; }
        
        /* Themes */
        .theme-classic { --bg-color: #f3f4f6; --text: #1f2937; }
        .theme-classic h1 { color: #ffffff !important; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        
        .theme-dark { --bg-color: #020617; --text: #f9fafb; }
        
        .theme-neon { --bg-color: #000000; --text: #00ffff; --neon-color: #00ffff; }
        .theme-neon .glass { 
            background: rgba(0, 0, 0, 0.8); 
            border: 2px solid var(--neon-color); 
            box-shadow: 0 0 15px var(--neon-color), inset 0 0 5px var(--neon-color);
            color: var(--neon-color);
        }
        .theme-neon h1 { color: #fff; text-shadow: 0 0 10px #0ff, 0 0 20px #0ff; }
        .theme-neon .cell { border: 1px solid rgba(0, 255, 255, 0.2); }
        .theme-neon .btn-menu { border: 1px solid var(--neon-color); }
        
        .theme-cyberglass { --bg-color: #020617; --text: #ffffff; --neon-color: #38bdf8; }
        .theme-cyberglass .glass { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(20px) saturate(180%); 
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(transparent, rgba(2, 6, 23, 0.9) 60%);
            pointer-events: none;
        }

        .footer-nav * { pointer-events: auto; }

        .ads-button {
            background: linear-gradient(135deg, #f97316, #c2410c);
            color: white !important;
            text-decoration: none !important;
            padding: 0.6rem 2rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .ads-button:active {
            transform: scale(0.94) translateY(2px);
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
            background: linear-gradient(135deg, #ea580c, #9a3412);
        }

        .btn-menu {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-menu:active { transform: scale(0.95); }
        
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
    </style>
</head>
<body class="theme-classic text-[var(--text)] transition-colors duration-500">
    <canvas id="bg-canvas"></canvas>

    <!-- Main Menu -->
    <div id="menu-screen" class="flex flex-col items-center justify-center min-h-screen p-6 space-y-8 pb-32">
        <div class="text-center">
            <h1 class="text-5xl font-bold mb-2 drop-shadow-2xl">Ø¯ÙˆØ² Ù¾ÛŒØ´Ø±ÙØªÙ‡</h1>
            <p class="opacity-60 text-sm">ØªØ¬Ø±Ø¨Ù‡â€ŒØ§ÛŒ Ù†ÙˆÛŒÙ† Ø§Ø² Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ²</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
            <!-- Two Player Button -->
            <button id="start-pvp-btn" class="btn-menu glass aspect-square flex flex-col items-center justify-center gap-3 rounded-3xl p-4 shadow-xl hover:bg-blue-500/10">
                <div class="w-16 h-16 bg-blue-500/20 rounded-2xl flex items-center justify-center text-blue-400">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </div>
                <span class="font-bold">Ø¯Ùˆ Ù†ÙØ±Ù‡</span>
            </button>

            <!-- Bot Player Button -->
            <button id="start-pve-btn" class="btn-menu glass aspect-square flex flex-col items-center justify-center gap-3 rounded-3xl p-4 shadow-xl hover:bg-purple-500/10">
                <div class="w-16 h-16 bg-purple-500/20 rounded-2xl flex items-center justify-center text-purple-400">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4M8 11v-1a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v1"/></svg>
                </div>
                <span class="font-bold">Ø¨Ø§ Ø±Ø¨Ø§Øª</span>
            </button>

            <!-- History Button -->
            <button id="open-history-btn" class="btn-menu glass aspect-square flex flex-col items-center justify-center gap-3 rounded-3xl p-4 shadow-xl hover:bg-orange-500/10">
                <div class="w-16 h-16 bg-orange-500/20 rounded-2xl flex items-center justify-center text-orange-400">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <span class="font-bold">ØªØ§Ø±ÛŒØ®Ú†Ù‡</span>
            </button>

            <!-- Settings Button -->
            <button id="open-settings-btn" class="btn-menu glass aspect-square flex flex-col items-center justify-center gap-3 rounded-3xl p-4 shadow-xl hover:bg-gray-500/10">
                <div class="w-16 h-16 bg-gray-500/20 rounded-2xl flex items-center justify-center text-gray-400">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </div>
                <span class="font-bold">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
            </button>
        </div>

    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-start justify-center p-6 bg-black/60 backdrop-blur-md pt-10 sm:pt-20">
        <div class="glass w-full max-w-sm rounded-3xl p-6 flex flex-col space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø²ÛŒ</h3>
                <button id="close-settings" class="p-1 hover:bg-white/10 rounded-full">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Board Size -->
            <div class="space-y-2">
                <label class="text-sm opacity-60">Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¬Ø¯ÙˆÙ„</label>
                <div class="flex gap-2">
                    <button data-size="3" class="size-btn flex-1 py-2 glass rounded-xl text-sm border-2 border-transparent">Û³Ã—Û³</button>
                    <button data-size="4" class="size-btn flex-1 py-2 glass rounded-xl text-sm border-2 border-transparent">Û´Ã—Û´</button>
                    <button data-size="5" class="size-btn flex-1 py-2 glass rounded-xl text-sm border-2 border-transparent">ÛµÃ—Ûµ</button>
                </div>
            </div>

            <!-- Difficulty (Visible always but applied for PVE) -->
            <div class="space-y-2">
                <label class="text-sm opacity-60">Ø³Ø®ØªÛŒ Ø±Ø¨Ø§Øª</label>
                <div class="flex gap-2">
                    <button data-diff="0" class="diff-btn flex-1 py-2 glass rounded-xl text-xs border-2 border-transparent">Ø¢Ø³Ø§Ù†</button>
                    <button data-diff="1" class="diff-btn flex-1 py-2 glass rounded-xl text-xs border-2 border-transparent">Ù…ØªÙˆØ³Ø·</button>
                    <button data-diff="2" class="diff-btn flex-1 py-2 glass rounded-xl text-xs border-2 border-transparent">Ø³Ø®Øª</button>
                </div>
            </div>

            <!-- Theme & Symbols Row -->
            <div class="grid grid-cols-2 gap-3">
                <div class="space-y-2">
                    <label class="text-sm opacity-60">Ù¾ÙˆØ³ØªÙ‡</label>
                    <select id="theme-select" class="w-full p-2 glass rounded-xl text-sm outline-none bg-transparent">
                        <option value="classic">Ú©Ù„Ø§Ø³ÛŒÚ©</option>
                        <option value="dark">ØªØ§Ø±ÛŒÚ©</option>
                        <option value="neon">Ù†Ø¦ÙˆÙ†</option>
                        <option value="cyberglass">Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-sm opacity-60">Ø·Ø±Ø­ Ù†Ù…Ø§Ø¯Ù‡Ø§</label>
                    <select id="symbol-select" class="w-full p-2 glass rounded-xl text-sm outline-none bg-transparent">
                        <option value="standard">Ú©Ù„Ø§Ø³ÛŒÚ© (X / O)</option>
                        <option value="geometric">Ø§Ø´Ú©Ø§Ù„ Ù‡Ù†Ø¯Ø³ÛŒ</option>
                        <option value="tech">ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ</option>
                        <option value="nature">Ø·Ø¨ÛŒØ¹Øª</option>
                    </select>
                </div>
            </div>

            <!-- Color Picker -->
            <div class="space-y-2">
                <label class="text-sm opacity-60">Ø±Ù†Ú¯ Ù†Ù…Ø§Ø¯Ù‡Ø§</label>
                <div class="flex items-center gap-6 glass p-3 rounded-xl">
                    <div class="flex items-center gap-3">
                        <input type="color" id="color-x" value="#3b82f6">
                        <span class="text-sm font-bold">Ù†Ù…Ø§Ø¯ Ø§ÙˆÙ„</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="color" id="color-o" value="#ef4444">
                        <span class="text-sm font-bold">Ù†Ù…Ø§Ø¯ Ø¯ÙˆÙ…</span>
                    </div>
                </div>
            </div>
            
            <button id="save-settings" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-bold shadow-lg mt-2">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="hidden flex flex-col items-center justify-between min-h-screen p-4 pb-8">
        <div class="w-full max-w-sm flex justify-between items-center glass p-3 rounded-xl">
            <button id="back-btn" class="p-2 hover:bg-white/10 rounded-lg">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            </button>
            <div class="flex gap-4 font-bold text-lg">
                <div id="score-x" class="text-blue-500">X: 0</div>
                <div class="opacity-30">|</div>
                <div id="score-o" class="text-red-500">O: 0</div>
            </div>
            <button id="toggle-audio" class="p-2 hover:bg-white/10 rounded-lg">
                <svg id="audio-icon-on" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5zM15.54 8.46a5 5 0 0 1 0 7.07M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                <svg id="audio-icon-off" class="hidden" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5zM23 9l-6 6M17 9l6 6"/></svg>
            </button>
        </div>

        <div id="board-container" class="w-full aspect-square max-w-[min(90vw,400px)] glass rounded-2xl p-4 grid gap-2 shadow-2xl relative">
            <!-- Grid cells injected here -->
        </div>

        <div class="flex flex-col gap-3 w-full max-w-sm">
            <div id="turn-indicator" class="text-center font-bold text-xl py-2 glass rounded-xl">Ù†ÙˆØ¨Øª: <span id="current-player-symbol">X</span></div>
            <div class="flex gap-2">
                <button id="reset-btn" class="flex-1 py-3 glass rounded-xl font-bold flex items-center justify-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ
                </button>
                <button id="history-btn" class="flex-1 py-3 glass rounded-xl font-bold flex items-center justify-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    ØªØ§Ø±ÛŒØ®Ú†Ù‡
                </button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm">
        <div class="glass w-full max-w-xs rounded-3xl p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§</h3>
                <button id="close-history" class="p-1 hover:bg-white/10 rounded-full">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="history-list" class="space-y-2 max-h-60 overflow-y-auto pr-2 text-sm">
                <!-- History items injected here -->
            </div>
            <button id="clear-history" class="mt-4 text-xs opacity-50 hover:opacity-100 transition-opacity">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-6 bg-black/80">
        <div class="glass p-8 rounded-3xl text-center scale-up shadow-2xl">
            <div id="win-message" class="text-4xl font-bold mb-6">X Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!</div>
            <button id="play-again-btn" class="btn-primary w-full">Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button>
        </div>
    </div>

    <!-- Persistent Footer -->
    <div id="persistent-footer" class="footer-nav">
        <div class="footer-animated font-bold text-sm tracking-wide">Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø³ÛŒØ¯ Ø¢Ø±ÙˆÛŒÙ† Ù…ÙˆØ³ÙˆÛŒ</div>
        <a href="https://eitaa.com/Arvinweb" class="ads-button" onclick="app.openArvin(event)">
            <span class="icon">ğŸ“¢</span>
            <span>Ø«Ø¨Øª ØªØ¨Ù„ÛŒØºØ§Øª</span>
        </a>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://esm.sh/three@0.160.0",
            "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';

        // --- State & Config ---
        const state = {
            mode: 'pvp', // pvp, pve
            size: 3,
            difficulty: 1, // 0: easy, 1: medium, 2: hard
            theme: 'classic',
            symbols: ['X', 'O'],
            colors: { X: '#3b82f6', O: '#ef4444' },
            scores: { X: 0, O: 0 },
            history: [],
            board: [],
            currentPlayer: 'X',
            isGameOver: false,
            audioEnabled: true,
            symbolsMap: {
                standard: [
                    '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
                    '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>'
                ],
                geometric: [
                    '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',
                    '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 22h20L12 2z"></path></svg>'
                ],
                tech: [
                    '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>',
                    '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>'
                ],
                nature: [
                    '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8a8 8 0 0 1-8 8c-1 0-1 0-2-.09V20z"></path><path d="M11 20c0-1.5-.7-3-2-3"></path><path d="M11 20c2 0 3.5-.7 3.5-2"></path></svg>',
                    '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>'
                ]
            }
        };

        // Default symbols
        state.symbols = state.symbolsMap.standard;

        // --- Persistence ---
        function saveState() {
            const data = {
                size: state.size,
                difficulty: state.difficulty,
                theme: state.theme,
                symbolType: document.getElementById('symbol-select').value,
                colors: state.colors,
                history: state.history,
                audioEnabled: state.audioEnabled
            };
            localStorage.setItem('tictactoe_state', JSON.stringify(data));
        }

        function loadState() {
            const saved = localStorage.getItem('tictactoe_state');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.size = data.size || 3;
                    state.difficulty = data.difficulty || 1;
                    state.theme = data.theme || 'classic';
                    state.colors = data.colors || { X: '#3b82f6', O: '#ef4444' };
                    state.history = data.history || [];
                    if (data.audioEnabled !== undefined) state.audioEnabled = data.audioEnabled;
                    
                    // Apply loaded values to UI
                    document.getElementById('theme-select').value = state.theme;
                    document.getElementById('symbol-select').value = data.symbolType || 'standard';
                    state.symbols = state.symbolsMap[data.symbolType || 'standard'];
                    document.getElementById('color-x').value = state.colors.X;
                    document.getElementById('color-o').value = state.colors.O;
                    
                    document.body.className = `theme-${state.theme} text-[var(--text)] transition-colors duration-500`;
                } catch (e) {
                    console.error("Failed to load state", e);
                }
            }
            
            // Sync Audio UI regardless of whether state was loaded or just defaulted
            const onIcon = document.getElementById('audio-icon-on');
            const offIcon = document.getElementById('audio-icon-off');
            if (state.audioEnabled) {
                onIcon.classList.remove('hidden');
                offIcon.classList.add('hidden');
            } else {
                onIcon.classList.add('hidden');
                offIcon.classList.remove('hidden');
            }
        }

        // --- Audio ---
        const audio = {
            bg: new Audio('music.mp3'),
            click: new Audio('click.mp3'),
            win: new Audio('win.mp3'),
            draw: new Audio('draw.mp3'),
            ctx: null
        };
        audio.bg.loop = true;

        function playSound(name) {
            if (!state.audioEnabled) return;
            const sound = audio[name];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(() => {});
            }
        }

        // --- Three.js Background ---
        let scene, camera, renderer, particles = [];
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);

            camera.position.z = 10;
        }

        function spawnParticle() {
            const isX = Math.random() > 0.5;
            let geometry;
            if (isX) {
                geometry = new THREE.BoxGeometry(0.1, 1, 0.1);
            } else {
                geometry = new THREE.TorusGeometry(0.4, 0.1, 8, 24);
            }

            const pColor = isX ? state.colors.X : state.colors.O;
            const material = new THREE.MeshStandardMaterial({ 
                color: new THREE.Color(pColor),
                emissive: new THREE.Color(pColor),
                emissiveIntensity: 0.5
            });

            const mesh = new THREE.Group();
            if (isX) {
                const bar1 = new THREE.Mesh(geometry, material);
                const bar2 = new THREE.Mesh(geometry, material);
                bar1.rotation.z = Math.PI / 4;
                bar2.rotation.z = -Math.PI / 4;
                mesh.add(bar1, bar2);
            } else {
                mesh.add(new THREE.Mesh(geometry, material));
            }

            mesh.position.set((Math.random() - 0.5) * 25, 12, (Math.random() - 0.5) * 10);
            mesh.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
            
            scene.add(mesh);
            particles.push({ mesh, speed: 0.03 + Math.random() * 0.08, rotSpeed: (Math.random() - 0.5) * 0.03 });
        }

        function animateThree() {
            requestAnimationFrame(animateThree);
            
            if (Math.random() < 0.15 && particles.length < 150) {
                spawnParticle();
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.mesh.position.y -= p.speed;
                p.mesh.rotation.x += p.rotSpeed;
                p.mesh.rotation.y += p.rotSpeed;
                
                if (p.mesh.position.y < -12) {
                    scene.remove(p.mesh);
                    particles.splice(i, 1);
                }
            }
            
            renderer.render(scene, camera);
        }

        window.playSound = playSound;

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- UI Elements ---
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const boardContainer = document.getElementById('board-container');
        const scoreX = document.getElementById('score-x');
        const scoreO = document.getElementById('score-o');
        const turnIndicator = document.getElementById('current-player-symbol');
        const winModal = document.getElementById('win-modal');
        const winMessage = document.getElementById('win-message');
        const historyModal = document.getElementById('history-modal');
        const historyList = document.getElementById('history-list');
        const persistentFooter = document.getElementById('persistent-footer');

        // --- Game Logic ---
        function initBoard() {
            state.board = Array(state.size * state.size).fill(null);
            state.isGameOver = false;
            state.currentPlayer = 'X';
            updateTurnUI();
            
            boardContainer.innerHTML = '';
            boardContainer.className = `w-full aspect-square max-w-[min(90vw,400px)] glass rounded-2xl p-4 grid gap-2 shadow-2xl relative grid-${state.size}`;
            
            for (let i = 0; i < state.size * state.size; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell glass rounded-lg text-3xl font-bold transition-all duration-200';
                cell.dataset.index = i;
                cell.onclick = () => handleMove(i);
                boardContainer.appendChild(cell);
            }
        }

        function handleMove(index) {
            if (state.board[index] || state.isGameOver) return;
            
            makeMove(index, state.currentPlayer);
            
            if (checkWinner(state.board, state.size)) {
                endGame(state.currentPlayer);
            } else if (state.board.every(cell => cell !== null)) {
                endGame('draw');
            } else {
                state.currentPlayer = state.currentPlayer === 'X' ? 'O' : 'X';
                updateTurnUI();
                
                if (state.mode === 'pve' && state.currentPlayer === 'O') {
                    boardContainer.style.pointerEvents = 'none';
                    setTimeout(() => {
                        const aiIndex = getBestMove();
                        handleMove(aiIndex);
                        boardContainer.style.pointerEvents = 'auto';
                    }, 600);
                }
            }
        }

        function makeMove(index, player) {
            state.board[index] = player;
            const cell = boardContainer.children[index];
            cell.innerHTML = state.symbols[player === 'X' ? 0 : 1];
            cell.style.color = state.colors[player];
            playSound('click');
        }

        function checkWinner(board, size) {
            const lines = [];
            // Rows
            for (let i = 0; i < size; i++) {
                const row = [];
                for (let j = 0; j < size; j++) row.push(i * size + j);
                lines.push(row);
            }
            // Cols
            for (let i = 0; i < size; i++) {
                const col = [];
                for (let j = 0; j < size; j++) col.push(j * size + i);
                lines.push(col);
            }
            // Diagonals
            const diag1 = [], diag2 = [];
            for (let i = 0; i < size; i++) {
                diag1.push(i * size + i);
                diag2.push(i * size + (size - 1 - i));
            }
            lines.push(diag1, diag2);

            for (const line of lines) {
                if (line.every(idx => board[idx] && board[idx] === board[line[0]])) {
                    return board[line[0]];
                }
            }
            return null;
        }

        function endGame(winner) {
            state.isGameOver = true;
            let resultText = '';
            
            if (winner === 'draw') {
                resultText = 'Ø¨Ø§Ø²ÛŒ Ù…Ø³Ø§ÙˆÛŒ Ø´Ø¯!';
            } else {
                const symbolLabel = winner === 'X' ? 'Ù†ÙØ± Ø§ÙˆÙ„ (X)' : 'Ù†ÙØ± Ø¯ÙˆÙ… (O)';
                resultText = `${symbolLabel} Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!`;
            }
            
            winMessage.textContent = resultText;
            
            if (winner !== 'draw') {
                state.scores[winner]++;
                updateScoreUI();
                playSound('win');
            } else {
                playSound('draw');
            }

            state.history.unshift({
                winner,
                size: state.size,
                mode: state.mode,
                time: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })
            });
            if (state.history.length > 20) state.history.pop();
            saveState();
            
            setTimeout(() => {
                winModal.classList.remove('hidden');
                history.pushState({ modal: 'win' }, '', '');
            }, 500);
        }

        function updateScoreUI() {
            scoreX.textContent = `X: ${state.scores.X}`;
            scoreO.textContent = `O: ${state.scores.O}`;
            scoreX.style.color = state.colors.X;
            scoreO.style.color = state.colors.O;
            scoreX.style.textShadow = `0 0 10px ${state.colors.X}44`;
            scoreO.style.textShadow = `0 0 10px ${state.colors.O}44`;
        }

        function updateTurnUI() {
            turnIndicator.innerHTML = state.symbols[state.currentPlayer === 'X' ? 0 : 1];
            turnIndicator.style.color = state.colors[state.currentPlayer];
        }

        // --- AI ---
        function getBestMove() {
            if (state.difficulty === 0) {
                const empties = state.board.map((v, i) => v === null ? i : null).filter(v => v !== null);
                return empties[Math.floor(Math.random() * empties.length)];
            }
            if (state.difficulty === 1 || state.size > 3) {
                const winMove = findWinningMove('O');
                if (winMove !== -1) return winMove;
                const blockMove = findWinningMove('X');
                if (blockMove !== -1) return blockMove;
                const center = Math.floor((state.size * state.size) / 2);
                if (state.board[center] === null) return center;
                const empties = state.board.map((v, i) => v === null ? i : null).filter(v => v !== null);
                return empties[Math.floor(Math.random() * empties.length)];
            }
            let bestScore = -Infinity;
            let move;
            for (let i = 0; i < 9; i++) {
                if (state.board[i] === null) {
                    state.board[i] = 'O';
                    let score = minimax(state.board, 0, false);
                    state.board[i] = null;
                    if (score > bestScore) {
                        bestScore = score;
                        move = i;
                    }
                }
            }
            return move;
        }

        function findWinningMove(player) {
            for (let i = 0; i < state.board.length; i++) {
                if (state.board[i] === null) {
                    state.board[i] = player;
                    if (checkWinner(state.board, state.size) === player) {
                        state.board[i] = null;
                        return i;
                    }
                    state.board[i] = null;
                }
            }
            return -1;
        }

        function minimax(board, depth, isMaximizing) {
            const result = checkWinner(board, 3);
            if (result === 'O') return 10 - depth;
            if (result === 'X') return depth - 10;
            if (board.every(cell => cell !== null)) return 0;
            if (isMaximizing) {
                let bestScore = -Infinity;
                for (let i = 0; i < 9; i++) {
                    if (board[i] === null) {
                        board[i] = 'O';
                        let score = minimax(board, depth + 1, false);
                        board[i] = null;
                        bestScore = Math.max(score, bestScore);
                    }
                }
                return bestScore;
            } else {
                let bestScore = Infinity;
                for (let i = 0; i < 9; i++) {
                    if (board[i] === null) {
                        board[i] = 'X';
                        let score = minimax(board, depth + 1, true);
                        board[i] = null;
                        bestScore = Math.min(score, bestScore);
                    }
                }
                return bestScore;
            }
        }

        // --- App Global Logic ---
        window.app = {
            openArvin: (event) => {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                const url = 'https://eitaa.com/Arvinweb';
                try { if(window.playSound) window.playSound('click'); } catch(e) {}
                try {
                    if (window.Eitaa && window.Eitaa.WebApp && typeof window.Eitaa.WebApp.openEitaaLink === 'function') {
                        window.Eitaa.WebApp.openEitaaLink(url);
                        return;
                    }
                } catch (e) {
                    console.warn("Eitaa openEitaaLink failed, falling back", e);
                }
                window.open(url, '_blank');
            }
        };

        // --- Event Listeners ---
        const settingsModal = document.getElementById('settings-modal');
        document.getElementById('start-pvp-btn').onclick = () => { state.mode = 'pvp'; startGame(); };
        document.getElementById('start-pve-btn').onclick = () => { state.mode = 'pve'; startGame(); };
        document.getElementById('open-history-btn').onclick = () => { renderHistory(); };
        document.getElementById('open-settings-btn').onclick = () => {
            settingsModal.classList.remove('hidden');
            updateSettingsUI();
            history.pushState({ modal: 'settings' }, '', '');
        };
        document.getElementById('close-settings').onclick = () => { history.back(); };

        function updateSettingsUI() {
            document.querySelectorAll('.size-btn').forEach(b => {
                const isActive = parseInt(b.dataset.size) === state.size;
                b.classList.toggle('active-choice', isActive);
            });
            document.querySelectorAll('.diff-btn').forEach(b => {
                const isActive = parseInt(b.dataset.diff) === state.difficulty;
                b.classList.toggle('active-choice', isActive);
            });
        }

        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.onclick = () => { state.size = parseInt(btn.dataset.size); updateSettingsUI(); };
        });

        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.onclick = () => { state.difficulty = parseInt(btn.dataset.diff); updateSettingsUI(); };
        });

        document.getElementById('save-settings').onclick = () => {
            state.theme = document.getElementById('theme-select').value;
            state.symbols = state.symbolsMap[document.getElementById('symbol-select').value];
            state.colors.X = document.getElementById('color-x').value;
            state.colors.O = document.getElementById('color-o').value;
            document.body.className = `theme-${state.theme} text-[var(--text)] transition-colors duration-500`;
            history.back();
            particles.forEach(p => scene.remove(p.mesh));
            particles = [];
            saveState();
        };

        function startGame() {
            menuScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            persistentFooter.classList.add('hidden');
            history.pushState({ view: 'game' }, '', '');
            initBoard();
            updateScoreUI();
        }

        document.getElementById('back-btn').onclick = () => {
            history.back();
        };

        document.getElementById('reset-btn').onclick = () => { initBoard(); };
        document.getElementById('play-again-btn').onclick = () => { 
            history.back();
            initBoard(); 
        };
        document.getElementById('history-btn').onclick = () => renderHistory();

        function renderHistory() {
            historyList.innerHTML = state.history.length ? '' : '<div class="opacity-50 text-center">Ù‡Ù†ÙˆØ² Ø¨Ø§Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
            state.history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'glass p-2 rounded-lg flex justify-between text-xs items-center';
                const result = item.winner === 'draw' ? 'ØªØ³Ø§ÙˆÛŒ' : `Ø¨Ø±Ù†Ø¯Ù‡: ${item.winner}`;
                div.innerHTML = `<span>${result} (${item.size}Ã—${item.size})</span> <span class="opacity-50">${item.time}</span>`;
                historyList.appendChild(div);
            });
            if (historyModal.classList.contains('hidden')) {
                history.pushState({ modal: 'history' }, '', '');
            }
            historyModal.classList.remove('hidden');
        }

        document.getElementById('close-history').onclick = () => history.back();
        document.getElementById('clear-history').onclick = () => {
            state.history = [];
            saveState();
            renderHistory();
        };

        document.getElementById('toggle-audio').onclick = () => {
            state.audioEnabled = !state.audioEnabled;
            document.getElementById('audio-icon-on').classList.toggle('hidden', !state.audioEnabled);
            document.getElementById('audio-icon-off').classList.toggle('hidden', state.audioEnabled);
            if (state.audioEnabled) {
                audio.bg.play().catch(() => {});
            } else {
                audio.bg.pause();
            }
            saveState();
        };

        // --- Navigation Logic ---
        window.addEventListener('popstate', (event) => {
            const winOpen = !winModal.classList.contains('hidden');
            const historyOpen = !historyModal.classList.contains('hidden');
            const settingsOpen = !settingsModal.classList.contains('hidden');
            const gameOpen = !gameScreen.classList.contains('hidden');

            if (winOpen) {
                winModal.classList.add('hidden');
            } else if (historyOpen) {
                historyModal.classList.add('hidden');
            } else if (settingsOpen) {
                settingsModal.classList.add('hidden');
            } else if (gameOpen) {
                gameScreen.classList.add('hidden');
                menuScreen.classList.remove('hidden');
                persistentFooter.classList.remove('hidden');
                state.scores = { X: 0, O: 0 };
            }
        });

        // --- Initialization & Audio Persistence Fix ---
        function initAudioOnInteraction() {
            // Explicitly load the background music
            audio.bg.load();
            
            const startAudio = () => {
                if (state.audioEnabled && audio.bg.paused) {
                    audio.bg.play().then(() => {
                        // If successfully started, we can remove the listeners
                        window.removeEventListener('click', startAudio);
                        window.removeEventListener('touchstart', startAudio);
                        window.removeEventListener('mousedown', startAudio);
                    }).catch(e => {
                        // If failed (e.g. browser still blocking), we keep the listeners to try again on next click
                        console.log("Audio play blocked, retrying on next interaction...");
                    });
                } else if (!state.audioEnabled) {
                    // If user has intentionally muted, we also remove listeners
                    window.removeEventListener('click', startAudio);
                    window.removeEventListener('touchstart', startAudio);
                    window.removeEventListener('mousedown', startAudio);
                }
            };
            
            window.addEventListener('click', startAudio);
            window.addEventListener('touchstart', startAudio);
            window.addEventListener('mousedown', startAudio);
        }

        // --- Start ---
        loadState();
        initThree();
        animateThree();
        initAudioOnInteraction();
    </script>
</body>
</html>